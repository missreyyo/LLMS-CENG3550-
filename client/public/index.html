<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum IPFS Metamask Example</title>
</head>
<body>
    <h1>Ethereum IPFS Metamask Example</h1>
    <div>
        <label for="ipfsInput">Text to be uploaded to IPFS:</label>
        <input type="text" id="ipfsInput">
        <label for="receiverAddress">Receiver Ethereum Address:</label>
        <input type="text" id="receiverAddress">
        <button onclick="uploadToIPFS()">Upload to IPFS</button>
    </div>
    <div>
        <p>IPFS Hash: <span id="ipfsHash"></span></p>
        <p>Contract IPFS Hash: <span id="contractHash"></span></p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ipfs-http-client/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="App.js"></script>

    <script>
        window.onload = async () => {
            
            if (window.ethereum) {
                window.web3 = new Web3(window.ethereum);
                try {
                    await window.ethereum.request({ method: 'eth_requestAccounts' });

                    window.ipfs = createIPFSInstance();

                    displayContractHash();
                } catch (error) {
                    console.error("User denied account access");
                }
            } else {
                console.error("No web3 provider detected");
            }
        };

        function createIPFSInstance() {
            return window.IpfsHttpClient({ host: 'ipfs.infura.io', port: 5001, protocol: 'https', headers: { authorization: '6008ad809050449eafff9403eba4b754' } });
        }

        async function uploadToIPFS() {
            const textToUpload = document.getElementById("ipfsInput").value;
            const receiverAddress = document.getElementById("receiverAddress").value;

            try {
               
                const ipfsResponse = await window.ipfs.add(textToUpload);
                const ipfsHash = ipfsResponse.cid.toString();

                document.getElementById("ipfsHash").innerText = ipfsHash;

               
                const accounts = await window.web3.eth.getAccounts();
                const contractAddress = '0xdCE5e8fAEE455Ae9929B031774b5c535B9c23b63';  
                const contractAbi = [
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "name": "dataEntries",
          "outputs": [
            {
              "internalType": "address",
              "name": "sender",
              "type": "address"
            },
            {
              "internalType": "string",
              "name": "ipfsHash",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function",
          "constant": true
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "_ipfsHash",
              "type": "string"
            }
          ],
          "name": "setIPFSHash",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "_sender",
              "type": "address"
            }
          ],
          "name": "getIPFSHash",
          "outputs": [
            {
              "internalType": "string",
              "name": "",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function",
          "constant": true
        }
      ];

                const contractInstance = new window.web3.eth.Contract(contractAbi, contractAddress);
                await contractInstance.methods.setIPFSHash(receiverAddress, ipfsHash).send({ from: accounts[0] });

                
                displayContractHash();
            } catch (error) {
                console.error("Error uploading to IPFS:", error);
            }
        }

        async function displayContractHash() {
            
            const accounts = await window.web3.eth.getAccounts();
            const contractAddress = '0xdCE5e8fAEE455Ae9929B031774b5c535B9c23b63';  
            const contractAbi = [
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "",
              "type": "address"
            }
          ],
          "name": "dataEntries",
          "outputs": [
            {
              "internalType": "address",
              "name": "sender",
              "type": "address"
            },
            {
              "internalType": "string",
              "name": "ipfsHash",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function",
          "constant": true
        },
        {
          "inputs": [
            {
              "internalType": "string",
              "name": "_ipfsHash",
              "type": "string"
            }
          ],
          "name": "setIPFSHash",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [
            {
              "internalType": "address",
              "name": "_sender",
              "type": "address"
            }
          ],
          "name": "getIPFSHash",
          "outputs": [
            {
              "internalType": "string",
              "name": "",
              "type": "string"
            }
          ],
          "stateMutability": "view",
          "type": "function",
          "constant": true
        }
      ];

            const contractInstance = new window.web3.eth.Contract(contractAbi, contractAddress);
            const contractHash = await contractInstance.methods.getIPFSHash(accounts[0]).call();

            document.getElementById("contractHash").innerText = contractHash;
        }
    </script>
</body>
</html>